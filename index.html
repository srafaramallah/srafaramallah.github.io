<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Turf.js Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª -->
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <style>
    #map { height: 90vh; }
    .button-container {
      margin: 10px;
    }
    button {
      margin: 5px;
      padding: 8px;
    }
  </style>
</head>
<body>

  <div class="button-container">
    <button onclick="loadData()">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <button onclick="calculateSimilarBranchDistances()">ğŸ“ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©</button>
  </div>

  <div id="map"></div>

  <script>
    let map = L.map('map').setView([31.95, 35.9], 8); // Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Ø§Ù„Ø¶ÙØ© Ø§Ù„ØºØ±Ø¨ÙŠØ©
    let srafaraLayer, governorateLayer;
    let allBranches = [];

    // Ø¥Ø¶Ø§ÙØ© Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† GitHub
    async function loadData() {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      if (srafaraLayer) map.removeLayer(srafaraLayer);
      if (governorateLayer) map.removeLayer(governorateLayer);
      allBranches = [];

      const srafaraURL = 'https://srafaramallah.github.io/srafara.json';
      const governorateURL = 'https://srafaramallah.github.io/Governorate.json';

      const [srafaraRes, governorateRes] = await Promise.all([
        fetch(srafaraURL),
        fetch(governorateURL)
      ]);

      const srafaraData = await srafaraRes.json();
      const governorateData = await governorateRes.json();

      // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
      governorateLayer = L.geoJSON(governorateData, {
        style: { color: '#999', weight: 1, fillOpacity: 0.1 }
      }).addTo(map);

      // Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙˆØ¹
      srafaraLayer = L.geoJSON(srafaraData, {
        onEachFeature: function (feature, layer) {
          const name = feature.properties["Ø§Ù„Ø§Ø³Ù…"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
          layer.bindPopup(`<b>${name}</b>`);
          allBranches.push({
            name: name,
            coords: feature.geometry.coordinates.reverse(), // [lat, lng]
            layer: layer
          });
        },
        pointToLayer: function (feature, latlng) {
          return L.circleMarker(latlng, { radius: 6, color: 'blue' });
        }
      }).addTo(map);
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©
    function calculateSimilarBranchDistances() {
      if (allBranches.length === 0) {
        alert("ÙŠØ¬Ø¨ Ø£ÙˆÙ„Ø§Ù‹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        return;
      }

      // ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
      let groups = {};
      for (let branch of allBranches) {
        if (!groups[branch.name]) {
          groups[branch.name] = [];
        }
        groups[branch.name].push(branch);
      }

      // Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ØªØ´Ø§Ø¨Ù‡Ø©ØŒ Ø§Ø®ØªØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø´ÙƒÙ„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
      Object.values(groups).forEach(group => {
        if (group.length < 2) return;

        const main = group[Math.floor(Math.random() * group.length)];
        main.layer.setStyle({ color: 'red' });
        main.layer.bindPopup(`<b>${main.name}</b><br>(ÙØ±Ø¹ Ø±Ø¦ÙŠØ³ÙŠ)`);

        for (let b of group) {
          if (b === main) continue;

          // Ø±Ø³Ù… Ø®Ø·
          const line = L.polyline([main.coords, b.coords], { color: 'green', weight: 2 }).addTo(map);

          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Turf
          const from = turf.point([main.coords[1], main.coords[0]]);
          const to = turf.point([b.coords[1], b.coords[0]]);
          const distance = turf.distance(from, to, { units: 'kilometers' }).toFixed(2);

          // Ø¥Ø¶Ø§ÙØ© Popup
          b.layer.bindPopup(`<b>${b.name}</b><br>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: ${distance} ÙƒÙ…`);
        }
      });
    }
  </script>
</body>
</html>

