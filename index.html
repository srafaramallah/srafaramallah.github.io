<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙØ±ÙˆØ¹ Ù…Ø¹ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet & Turf -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <!-- XLSX Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    #map { height: 85vh; }
    .controls {
      margin: 10px;
    }
    select, button {
      margin: 5px;
      padding: 6px;
    }
  </style>
</head>
<body>

  <div class="controls">
    <select id="companySelect" onchange="filterByCompany()">
      <option value="">ğŸ” Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</option>
    </select>
    <button onclick="loadData()">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <button onclick="calculateSimilarBranchDistances()">ğŸ“ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª</button>
    <button onclick="exportToExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
  </div>

  <div id="map"></div>

  <script>
    let map = L.map('map').setView([31.95, 35.9], 8);
    let srafaraLayer, filteredLayer;
    let allBranches = [];
    let filteredBranches = [];
    let distanceResults = [];
    let lineGroup = L.layerGroup().addTo(map);

    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function loadData() {
      if (srafaraLayer) map.removeLayer(srafaraLayer);
      if (filteredLayer) map.removeLayer(filteredLayer);
      lineGroup.clearLayers();
      allBranches = [];
      distanceResults = [];
      document.getElementById("companySelect").innerHTML = '<option value="">ğŸ” Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</option>';

      const srafaraURL = 'https://srafaramallah.github.io/srafara.json'; // â† ØºÙŠÙ‘Ø±Ù‡ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø·Ùƒ Ø§Ù„ØµØ­ÙŠØ­
      const res = await fetch(srafaraURL);
      const data = await res.json();

      srafaraLayer = L.geoJSON(data, {
        onEachFeature: function (feature, layer) {
          const name = feature.properties["Ø§Ø³Ù…_Ø§"];
          const address = feature.properties["Ø§Ù„Ø¹Ù†Ùˆ"] || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
          if (name) {
            const coords = feature.geometry.coordinates.slice().reverse(); // lat,lng
            allBranches.push({ name, coords, layer, address });
          }
        },
        pointToLayer: (feature, latlng) => L.circleMarker(latlng, { radius: 6, color: 'gray' })
      }).addTo(map);

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
      const uniqueNames = [...new Set(allBranches.map(b => b.name))].sort();
      const select = document.getElementById("companySelect");
      uniqueNames.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });

      alert("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©.");
    }

    // ÙÙ„ØªØ±Ø© Ø§Ù„ÙØ±ÙˆØ¹ Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©
    function filterByCompany() {
      const selectedName = document.getElementById("companySelect").value;
      distanceResults = [];
      lineGroup.clearLayers();

      if (filteredLayer) map.removeLayer(filteredLayer);
      if (!selectedName) return;

      filteredBranches = allBranches.filter(b => b.name === selectedName);

      filteredLayer = L.layerGroup();
      filteredBranches.forEach(b => {
        const marker = L.circleMarker(b.coords, { radius: 6, color: 'blue' })
          .bindPopup(`<b>${b.name}</b><br><small>${b.address}</small>`)
          .addTo(filteredLayer);
        b.layer = marker;
      });
      filteredLayer.addTo(map);
      map.fitBounds(filteredLayer.getBounds());
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆÙØªØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ° (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
    function calculateSimilarBranchDistances() {
      if (!filteredBranches || filteredBranches.length < 2) {
        alert("ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙƒØ«Ø± Ù…Ù† ÙØ±Ø¹.");
        return;
      }

      distanceResults = [];
      lineGroup.clearLayers();

      const main = filteredBranches[Math.floor(Math.random() * filteredBranches.length)];
      main.layer.setStyle({ color: 'red' });
      const mainPopup = `<b>${main.name}</b><br>${main.address}<br>(ÙØ±Ø¹ Ø±Ø¦ÙŠØ³ÙŠ)`;
      main.layer.bindPopup(mainPopup).openPopup();

      filteredBranches.forEach(branch => {
        if (branch === main) return;

        const from = turf.point([main.coords[1], main.coords[0]]);
        const to = turf.point([branch.coords[1], branch.coords[0]]);
        const dist = turf.distance(from, to, { units: 'kilometers' });
        const distText = dist.toFixed(2);

        distanceResults.push({
          "Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ": main.name,
          "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ": main.address,
          "Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ": `${main.coords[0]}, ${main.coords[1]}`,
          "Ø§Ù„ÙØ±Ø¹": branch.name,
          "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ±Ø¹": branch.address,
          "Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ÙØ±Ø¹": `${branch.coords[0]}, ${branch.coords[1]}`,
          "Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)": distText
        });

        // Ø±Ø³Ù… Ø§Ù„Ø®Ø·
        L.polyline([main.coords, branch.coords], { color: 'green', weight: 2 }).addTo(lineGroup);

        // Popup Ù…Ø¹ ÙØªØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠ
        const popupContent = `<b>${branch.name}</b><br>${branch.address}<br>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: ${distText} ÙƒÙ…`;
        branch.layer.bindPopup(popupContent).openPopup();
      });

      alert("ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹.");
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ Excel Ù…Ø¹ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    function exportToExcel() {
      if (distanceResults.length === 0) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");
        return;
      }

      const ws = XLSX.utils.json_to_sheet(distanceResults);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…Ø³Ø§ÙØ§Øª");
      XLSX.writeFile(wb, "Ø§Ù„Ù…Ø³Ø§ÙØ§Øª_Ø¨ÙŠÙ†_Ø§Ù„ÙØ±ÙˆØ¹.xlsx");
    }
  </script>
</body>
</html>
